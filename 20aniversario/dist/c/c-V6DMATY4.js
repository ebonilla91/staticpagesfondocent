import{b as m,e as A}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-2EGNLUPQ.js";import{m as R,n as a,o as H}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-PJF6UIFY.js";import{a as P}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-CHUQBVQY.js";import{h as B,m as O,q as Y}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-QQSGI2X4.js";import{b as d,c as j}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-OAY73AJW.js";import{a as y}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-BHCSVH3M.js";import{a as S,b as Q}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-F5RDH3FM.js";import{a as I}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-L5GBYYT7.js";import{a as L,c as T,d as c,e as C}from"https://d1id5eheivyv24.cloudfront.net/98c7974b/dist/c/c-IDSWT3EJ.js";var D,Z,x,F=L(()=>{"use strict";D=c(P()),Z=D.default.Model.extend({idAttribute:"_id",urlRoot:"/api/folders/"}),x=D.default.Collection.extend({model:Z,getByUri:function(e){return this.findWhere({uri:e})}})});var $,h,M,X,N=L(()=>{"use strict";$=c(P()),h=c(I());H();j();Q();A();M=c(y());Y();X=$.default.Model.extend({idAttribute:"_id",url:function(){if(this.get("user")&&this.get("uri")){let t=this.get("user");h.default.isObject(t)&&(t=t.get("uri"));var e=t+"/"+this.get("uri")}else var e=this.getId();return"/api/readymag/"+e},PUBLISH_URL:"/api/publish/",UNPUBLISH_URL:"/api/unpublish/",parse:function(e){let{MagList:t}=(k(),C(V)),{UserModel:i}=(q(),C(z));return e.user&&(this.user=new i(e.user),delete e.user),e.title||(e.emptyTitle=!0),e.title=e.title||"Project",h.default.isEmpty(e.recentMags)||(this.recentMags=new t(e.recentMags,{parse:!0})),e},getPageNumId:function(e){if(!this.get("pages"))return"";let t=h.default.find(this.get("pages"),function(i){return i.num==e});return t?t.num_id:""},getPageId:function(e){if(!this.get("pages"))return"";let t=h.default.find(this.get("pages"),function(i){return i.num==e});return t?t._id:""},getPageScreenshot:function(e,t,i="default"){let s=h.default.findWhere(this.get("pages"),e),f=s?.viewport_phone_portrait?.enabled,o=s?.viewport_tablet_portrait?.enabled,u=i==="phone_portrait"&&f&&s?.viewport_phone_portrait?.screenshot,n=i==="tablet_portrait"&&o&&s?.viewport_tablet_portrait?.screenshot,g=u||n||s?.screenshot,K=u?R.half:R.quarter,w=a.getScreenshotSizeByToken(K,u?"phone_portrait":n?"tablet_portrait":"default"),b=B.default,_=O(u?"phone_portrait":n?"tablet_portrait":"default",t);return e.specialScreenshot?{src:e.specialScreenshot,...b}:e.cover?!this.get("cover")&&this.get("pages")?this.getPageScreenshot({_id:this.get("coverPid")},t,i):this.get("cover")?{src:a.addFilenameComponent(this.get("cover"),w),...b}:{src:`/api/screenshot/renew/${this.get("num_id")}/${this.get("coverPid")}/${this.get("is_published")?"ready":""}?viewport=${i}&redirect=true&size=${w}`,..._}:this.get("pages")?s&&s.unauthorized?{src:this.get("pass_bg")?this.get("pass_bg"):m("./viewer/mag-password/bg.jpg"),...b}:!g&&s?{src:`/api/screenshot/renew/${this.get("num_id")}/${s._id}/${this.get("is_published")?"ready":""}?viewport=${i}&redirect=true&size=${w}`,..._}:g&&!isNaN(Number(a.getFilenameComponent(g)))?{src:g,..._}:{src:g&&a.addFilenameComponent(g,w),..._}:(console.error("cannot find page screenshot: ",this,e),{src:void 0,...b})},getLink:function(){if(!S.isDesktop)return this.getUnpublishedViewerLink();let e=this.get("is_published")&&this.get("uri")||this.getId();return RM.common.customDomainProfile?"/"+e+"/":d.readymag_host+"/"+this.user.get("uri")+"/"+e+"/"},getUnpublishedViewerLink:function(){return d.readymag_auth_host+"/"+this.user.get("uri")+"/"+this.get("num_id")},getMagEditLink:function(){return d.readymag_auth_host+"/edit/"+this.getId()+"/"},getMagEditContentsLink:function(){return S.isDesktop?this.getMagEditLink()+"contents/":this.getUnpublishedViewerLink()},getMagSettingsLink:function(){return this.getMagEditLink()+"settings/"},getId:function(){return this.get("num_id")},getPagesCount:function(){return this.get("pages_count")||this.get("pages")&&this.get("pages").length},deleteMag:function(e){this.deleteXHR&&this.deleteXHR.abort(),this.deleteXHR=M.default.ajax({type:"DELETE",url:"/api/mags/archive",data:JSON.stringify({mag_num_ids:[Number(this.getId())],folder_num_ids:[]}),contentType:"application/json; charset=utf-8",success:function(t){typeof e.success=="function"&&e.success(t)},error:function(t){console.log("Error deleting mag: "+t.responseText),this.onError("A problem occurred while deleting your project. Please, contact us: "+d.SUPPORT_MAIL)},context:this}).always(function(){typeof e.always=="function"&&e.always()})},_changePublishState:function(e,t){let i=e&&(e==="publish"||e==="republish")?this.PUBLISH_URL:this.UNPUBLISH_URL;this.publishXHR&&this.publishXHR.abort(),this.publishXHR=M.default.ajax({type:"POST",url:i+this.getId(),success:function(s){this.set("is_published",e&&e!=="unpublish"),e==="publish"&&(this.set("published",s.published||new Date().toISOString()),this.set("updated",s.updated||new Date().toISOString()),this.set("major_update",s.major_update||new Date().toISOString())),e==="republish"&&this.set(h.default.extend(h.default.omit(s,"user"),{updated:this.get("last_changed")})),this.set("coverPid",s.coverPid||this.get("coverPid")),this.set("cover",s.cover||this.get("cover")),typeof t.success=="function"&&t.success()},error:function(s){console.log("Error changing puplish state: "+s.responseText),this.onError("A problem occurred while "+e+"ing your project. Please, contact us: "+d.SUPPORT_MAIL)},context:this}).always(function(){typeof t.always=="function"&&t.always()})},publishMag:function(e){this._changePublishState("publish",e)},unpublishMag:function(e){this._changePublishState("unpublish",e)},republishMag:function(e){this._changePublishState("republish",e)},duplicateMag:function(e){let t="/api/mag/"+this.get("num_id")+"/duplicate",i;i={type:"POST",url:t,context:this},h.default.extend(i,e),this.duplicateXHR&&this.duplicateXHR.abort(),this.duplicateXHR=M.default.ajax(i)},hasUnsavedChanges:function(){return this.get("is_published")&&this.get("changed")},onError:function(e){alert(e)}})});var V={};T(V,{MagList:()=>p});var W,G,p,k=L(()=>{"use strict";W=c(P());N();G=c(y()),p=W.default.Collection.extend({model:X,load:function(e={}){let t=e.success||G.default.noop;this.loaded;let i=this;return e.success=function(){t(i),i.loaded=!0},this.fetch(e)},comparator:function(e){return-new Date(e.get("major_update")).getTime()}})});var z={};T(z,{UserModel:()=>U,UsersCollection:()=>J,UsersLoader:()=>E,loadUser:()=>ee});var l,v,r,U,J,E,ee,q=L(()=>{"use strict";l=c(y()),v=c(P()),r=c(I());j();H();F();k();A();U=v.default.Model.extend({userpic_sizes:[64,96,128,192,256],mergePermissionsList:["can_publish"],idAttribute:"uri",url:"/api/me/",initialize:function(){r.default.bindAll(this)},store:function(e,t){(!e.name||/^\s$/.test(e.name))&&(e.name=this.get("name")),e=this.changedAttributes(e),this.set(e),this.validate(e)||l.default.ajax({type:"PUT",url:this.url,data:e,success:t&&typeof t.success=="function"&&t.success,error:t&&typeof t.error=="function"&&t.error})},deletePic:function(){let e=this;l.default.ajax({type:"DELETE",url:"/api/me/pic/",success:function(){e.set("pic","")}})},validate:function(e){if(e.name!==void 0&&r.default.isEmpty(l.default.trim(e.name)))return"Name yourself"},getUserpic:function(e){let t=this.get("pic"),i;return Modernizr.retina&&(e=e*2),e=r.default.find(this.userpic_sizes,function(s){return s>=e}),t?(t=a.addFilenameComponent(t,e),t.indexOf("https://")==0||RM.common.isDownloadedSource||t.indexOf("/api/upload/")==-1&&(t="/api/upload/"+t),t):(i=this.get("name").match(/^[a-z0-9]{1}/i),i?m("./stubs/avatar/"+i[0].toLowerCase()+".gif"):m("./stubs/avatar/"+e+".gif"))},getLink:function(){return RM.common.customDomainProfile?"/":RM.common.isDomainViewer?d.readymag_host+"/"+this.get("uri"):"/"+this.get("uri")},getWebsiteButified:function(){let e,t={link:"",label:""};return this.get("website")&&(e=a.URLParts(this.get("website")),e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path,t.label=e.hostname),t},getTwitterButified:function(){let e,t={link:"",nick:""};return this.get("twitter")&&(e=a.URLParts(this.get("twitter")),!e.protocol&&!e.path?(e.protocol="http://",t.nick=e.hostname,e.path="/"+t.nick,e.hostname="twitter.com"):(e.protocol=e.protocol||"http://",t.nick=e.path.split("/")[1]),t.link=e.protocol+e.hostname+e.path),t},getFacebookButified:function(){let e,t={link:"",nick:""};if(this.get("fb")){e=a.URLParts(this.get("fb"));try{e.path.indexOf("profile.php")!=-1?t.nick="facebook":e.path.split("/")[1]=="pages"?t.nick=decodeURIComponent(e.path.split("/")[2])||"":!e.protocol&&!e.path?(t.nick=e.hostname,e.hostname="facebook.com",e.path="/"+t.nick):t.nick=e.path.split("/")[1].split("?")[0]||"",e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path}catch(i){console.log("Error parsing FB URL: ",i)}}return t},mergePermissions:function(e){let t=r.default.clone(this.get("permissions"));this.set("permissions",e),r.default.each(this.mergePermissionsList,function(i){this.attributes.permissions[i]=this.attributes.permissions[i]&&t[i]},this)},resendConfirmationEmail:function(){l.default.get("/auth/confirm/resend")},isPublisher:function(){return this.get("permissions").can_publish},checkDomain:function(e,t){return l.default.ajax({type:"POST",url:"/api/checkdomain",data:{type:"user",domain:e},success:r.default.bind(function(i){this.set({last_checked_domain:e},{silent:!0}),t&&t(i)},this),error:r.default.bind(function(){console.error(arguments),t&&t(null)},this)})},mapDomain:function(e,t){return t=t||{},l.default.ajax({type:"POST",url:"/api/user/domain/",data:{domain:e,status:"on"},success:r.default.bind(function(i){this.set({domain:e},{silent:!0}),t.success&&t.success(i)},this),error:r.default.bind(function(i){return i&&i.status>=500?t.error(null):t.error&&t.error({badDNSSettings:!0})},this)})},unmapDomain:function(e){return l.default.ajax({type:"POST",url:"/api/user/domain/",data:{status:"off"},success:r.default.bind(function(t){this.unset("domain",{silent:!0}),e&&e(t)},this),error:r.default.bind(function(){console.error(arguments),e&&e(null)},this)})},isBetaTester:function(){return!!(this.get("permissions")||{}).can_use_beta_testing}}),J=v.default.Collection.extend({model:U}),E=function(){this.allUsers=new J,this.userMags={},this.userFolders={},r.default.bindAll(this)};E.prototype={LOAD_URL:"/api/readymags/user/",loadByUsername:function(e){var t,i;if(RM.common.customDomainProfile&&this.allUsers.at(0)){var t=this.allUsers.at(0),i=this.userMags[this.allUsers.at(0).get("uri")];return t.folders=this.userFolders[this.allUsers.at(0).get("uri")],e.success&&e.success({user:t,mags:i})}let s=this.allUsers.find(function(o){return o.get("uri").toLowerCase()==e.user_uri.toLowerCase()}),f=r.default.bind(function(o){let u,n;if(!o.user)return e.success({user:o});this.load(o,e.is_me),u=this.allUsers.get(o.user.uri),n=this.userMags[o.user.uri],u.folders=this.userFolders[o.user.uri],e.success&&e.success({user:u,mags:n})},this);s&&!e.force?(i=this.userMags[s.get("uri")],s.folders=this.userFolders[s.get("uri")],e.success({user:s,mags:i})):this.request(e.user_uri,{success:f,error:e.error})},load:function(e,t){let i;if(r.default.isEmpty(e))return;let s=e.user||e,f=e.mags,o=s.folders||[];if(s){i=s.uri,x&&(this.userFolders[i]=new x(o,{parse:!0}),delete s.folders),this.allUsers.remove(i),this.allUsers.add(s),t&&s.contributors&&r.default.each(s.contributors,function(n){n.member&&(n.member=new U(n.member))});let u=r.default.pick(s,"_id","uri","desc","pic");t&&(u.isMe=t),r.default.each(f,function(n){n.user=r.default.clone(u)}),p&&(this.userMags[i]=new p(f,{parse:!0}),t&&!r.default.isEmpty(f)&&this.userMags[i].each(function(n){n.user.set("isMe",!0)}))}},loadShared:function(e){r.default.isEmpty(e)||(this.sharedMags={},r.default.each(e,function(t){let i=r.default.pick(t.user,"_id","uri","desc","pic");r.default.each(t.mags,function(s){s.user=r.default.clone(i)}),this.sharedMags[t.user.uri.toLowerCase()]={user:new U(t.user),mags:new p(t.mags,{parse:!0})}},this))},request:function(e,t){RM.common.customDomainProfile&&(this.LOAD_URL="/api/domain/readymags/user/",e=""),t=t||{},this.abortLoading(),this.loadingXHR=l.default.ajax(r.default.extend(t,{type:"GET",url:this.LOAD_URL+e}))},abortLoading:function(){this.loadingXHR&&this.loadingXHR.abort&&this.loadingXHR.abort()}};ee=()=>{window.RM.data.usersLoader=new E;let e=window.ServerData.me;window.RM.data.usersLoader.load(e,!0),e?(e=e.user||e,e.uri&&(window.RM.data.usersLoader.me=window.RM.data.usersLoader.allUsers.get(e.uri))):window.RM.data.usersLoader.me=!1,window.ServerData.mags&&window.ServerData.mags.user&&window.ServerData.mags.mags&&(!window.RM.data.usersLoader.me||window.RM.data.usersLoader.me.get("uri")!==window.ServerData.mags.user.uri)&&window.RM.data.usersLoader.load(window.ServerData.mags),window.ServerData.shared&&window.RM.data.usersLoader.loadShared(window.ServerData.shared),r.default.isEmpty(window.ServerData.sharedError)||(window.RM.data.usersLoader.sharedError=window.ServerData.sharedError)}});export{X as a,N as b,U as c,J as d,ee as e,q as f};
